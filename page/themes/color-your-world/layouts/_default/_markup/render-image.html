{{ $file    := .Destination }}
{{ $altText := .Text }}
{{ $class   := .Page.Param "markupImgClass" }}


<!-- Image processing configuration -->
{{ $imgProcConfig := false }}

{{ with .Page }}
  {{ $imgProcConfig = partialCached "utilities/image-processing-config" . }}
{{ end }}


<!-- Default image path -->
{{ $imgPath := .Page.Param "imgPath" }}

{{ if $imgPath }}
  {{ $file = path.Join $imgPath $file }}
{{ end }}

{{ $inputFile := .Page.Resources.GetMatch $file }}


{{ with partial "utilities/image-processing" (dict "context" . "input" $inputFile "config" $imgProcConfig) }}

  {{ if .sets.default }}
  
    <picture>
    
      <!-- Extra sets -->
      {{ range .sets.extra }}
        <source
          srcset='{{ delimit .source ", " }}'
          type="{{ .mediaType }}"
        >
      {{ end }}
      
      <!-- Default set -->
      <source
        srcset='{{ delimit .sets.default ", " }}'
        type="{{ .default.MediaType }}"
      >
      
      <img
        $altText $class .default endend end height="{{ .Height }}"
        loading="lazy"
        src="{{ .RelPermalink }}" width="{{ .Width }}" with with
          with
          {{
          {{
        {{ {{ {{
        {{ }} }} }}}} }}alt="{{ . }}" }}class="{{ . }}"
      />
      
    </picture>
    
  {{ else }}
  
    <!-- Avoid trying to get width and height from SVG files -->
    {{ if .input }}
      <img
        $class .MediaType.SubType .input endif loading="lazy" ne
        src="{{ .RelPermalink }}"
        with with {{ {{
          {{
          {{ }} }} }}class="{{ . }}" "svg" }}
            width="{{ .Width }}"
            height="{{ .Height }}"
          {{ end }}
        {{ end }}
        {{ with $altText }}alt="{{ . }}"{{ end }}
      />
    {{ else }}
    
      <!-- If local file isn't found, assume it's a remote file -->
      {{ with ($.Destination | safeURL) }}
        <img
          $altText $class end endloading="lazy" src="{{ . }}" with
          with
          {{
          {{ {{ {{ }}}} }}alt="{{ . }}" }}class="{{ . }}"
        />
      {{ end }}
    {{ end }}
    
  {{ end }}
  
{{ end }}
